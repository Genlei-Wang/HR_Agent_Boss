var ye=Object.defineProperty;var be=(s,t,e)=>t in s?ye(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var ae=(s,t,e)=>be(s,typeof t!="symbol"?t+"":t,e);import{G,b as we,M as L,S as Z}from"./utils-7X23tBXC.js";const Ie="modulepreload",Se=function(s){return"/"+s},de={},re=function(t,e,n){let i=Promise.resolve();if(e&&e.length>0){document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),a=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));i=Promise.allSettled(e.map(u=>{if(u=Se(u),u in de)return;de[u]=!0;const g=u.endsWith(".css"),I=g?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${u}"]${I}`))return;const p=document.createElement("link");if(p.rel=g?"stylesheet":Ie,g||(p.as="script"),p.crossOrigin="",p.href=u,a&&p.setAttribute("nonce",a),document.head.appendChild(p),g)return new Promise((S,N)=>{p.addEventListener("load",S),p.addEventListener("error",()=>N(new Error(`Unable to preload CSS for ${u}`)))})}))}function h(o){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=o,window.dispatchEvent(a),!a.defaultPrevented)throw o}return i.then(o=>{for(const a of o||[])a.status==="rejected"&&h(a.reason);return t().catch(h)})},Te="你是HR助手，根据JD分析候选人截图，判断是否匹配。评判：技能、行业、年限、项目经验。仅输出JSON，满足60%要求即匹配。";function Oe(s){return`JD要求：${s}

分析图片中的候选人，输出JSON：


${i}`;n&&await ce(n.sessionDir||"default",n.index,n.name,h,t);try{const o=await this.callGeminiAPI(h,t),a=this.parseResponse(o);return n&&await he(n.sessionDir||"default",n.index,n.name,o,a),a}catch(o){throw console.error("[GeminiService] API call failed:",o),new Error(`Gemini API调用失败: ${o.message}`)}}async callGeminiAPI(t,e){var u;const n=[{text:t}];e&&n.push({inline_data:{mime_type:"image/png",data:e}});const i={contents:[{role:"user",parts:n}],generationConfig:{temperature:G.TEMPERATURE,topK:G.TOP_K,topP:G.TOP_P,maxOutputTokens:G.MAX_OUTPUT_TOKENS}},h=`${G.API_ENDPOINT}?key=${this.apiKey}`,o=new AbortController,a=setTimeout(()=>o.abort(),G.TIMEOUT);try{const g=await fetch(h,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i),signal:o.signal});if(clearTimeout(a),!g.ok){const p=await g.text();,console.error("[GeminiService] API Error:",p);try{const N=((u=JSON.parse(p).error)==null?void 0:u.message)||p;throw new Error(`API调用失败 (${g.status}): ${N}`)}catch{throw new Error(`API调用失败 (${g.status}): ${p.substring(0,200)}`)}}const I=await g.json();return ,console.log("[GeminiService] API Response received"),I}catch(g){throw clearTimeout(a),g.name==="AbortError"?new Error("请求超时"):g}}parseResponse(t){var e,n,i,h,o,a,u,g,I;try{;const p=((I=(g=(u=(a=(o=t.candidates)==null?void 0:o[0])==null?void 0:a.content)==null?void 0:u.parts)==null?void 0:g[0])==null?void 0:I.text)||"";if(,!p)throw new Error("AI响应为空");const S=we(p);if(,!S)throw new Error("无法从AI响应中提取JSON");if(typeof S.match!="boolean")throw new Error("AI响应缺少match字段或格式错误");return{match:S.match,confidence:S.confidence||.5,reason:S.reason||"未提供原因",highlights:Array.isArray(S.highlights)?S.highlights:[]}}catch(p){return console.error("[GeminiService] Failed to parse response:",p),console.error("[GeminiService] Raw data:",t),{match:!1,confidence:0,reason:`解析AI响应失败: ${p.message}`,highlights:[]}}}async testApiKey(){var t,e,n;try{console.log("[GeminiService] Testing API Key...");const i=await this.callGeminiAPI(Ce);return console.log("[GeminiService] API Key test successful:",i),{valid:!0}}catch(i){return console.error("[GeminiService] API Key test failed:",i),console.error("[GeminiService] Error details:",i.message),((t=i.message)==null?void 0:t.includes("429"))||((e=i.message)==null?void 0:e.includes("quota"))||((n=i.message)==null?void 0:n.includes("RESOURCE_EXHAUSTED"))?{valid:!1,error:`API配额已用完（免费版每天20次请求）

请等待配额恢复（约1小时后）或升级API计划`,quotaExceeded:!0}:{valid:!1,error:i.message||"API Key测试失败",quotaExceeded:!1}}}}class Pe{static async captureArea(t){try{const n={x:t.x,y:t.y,width:t.width,height:Math.min(t.height,1e4)};,t=n;const[i]=await chrome.tabs.query({active:!0,currentWindow:!0});if(,!(i!=null&&i.id)||!i.windowId)throw new Error("No active tab found");let h;try{h=await chrome.tabs.captureVisibleTab({format:"png"})}catch(g){;try{h=await chrome.tabs.captureVisibleTab(i.windowId,{format:"png"})}catch(I){throw ,I}}const o=await this.cropImage(h,t),a=Math.round(o.length/1024),u=Math.round(a*3/4);return ,o}catch(e){throw ,console.error("[ScreenshotService] Capture failed:",e),new Error(`截图失败: ${e.message}`)}}static async cropImage(t,e){try{const i=await(await fetch(t)).blob(),h=await createImageBitmap(i),o=h.width,a=h.height,u=945,g=817,I=o/u,p=a/g,S={x:e.x*I,y:e.y*p,width:e.width*I,height:e.height*p};;const N=Math.max(0,Math.min(Math.round(S.x),o-1)),B=Math.max(0,Math.min(Math.round(S.y),a-1)),J=Math.min(Math.round(S.width),o-N),j=Math.min(Math.round(S.height),a-B);;const M=J,H=j,U=new OffscreenCanvas(M,H),Y=U.getContext("2d");if(!Y)throw new Error("Failed to get canvas context");Y.drawImage(h,N,B,J,j,0,0,M,H),;const V=await(await U.convertToBlob({type:"image/png"})).arrayBuffer(),f=new Uint8Array(V);let b="";const T=8192;for(let r=0;r<f.length;r+=T){const m=f.subarray(r,Math.min(r+T,f.length));b+=String.fromCharCode.apply(null,Array.from(m))}return btoa(b)}catch(n){throw console.error("[ScreenshotService] Crop failed:",n),new Error(`图片裁剪失败: ${n.message}`)}}}let $=null;async function Ee(){if(,$)return ,$;;const s=await chrome.storage.local.get(Z.API_KEY),t=s[Z.API_KEY];if(,!t)throw ,new Error("未配置API Key");return $=new fe(t),$}async function Re(s){var t,e,n,i,h;;try{const o=await Pe.captureArea(s.rect);if(,s.candidateInfo){const{saveScreenshot:g}=await re(async()=>{const{saveScreenshot:I}=await Promise.resolve().then(()=>Ae);return{saveScreenshot:I}},void 0);await g(s.candidateInfo.sessionDir||"default",s.candidateInfo.index,s.candidateInfo.name,o);try{const{saveScreenshotWithThumbnail:I}=await re(async()=>{const{saveScreenshotWithThumbnail:p}=await import("./file-saver-DMO37nmV.js");return{saveScreenshotWithThumbnail:p}},[]);await I(o,s.candidateInfo.name,s.candidateInfo.index,s.candidateInfo.sessionDir||"default")}catch(I){console.error("[Background] 保存截图文件失败:",I)}};const u=await(await Ee()).analyzeCandidate(o,s.jobDescription,s.candidateInfo);return ,{success:!0,result:{...u,screenshotBase64:o}}}catch(o){return ,console.error("[Background] Analyze candidate failed:",o),{success:!1,error:o.message||"分析失败"}}}async function ve(s){var t,e,n;;try{const i=new fe(s.apiKey);;const h=await i.testApiKey();return ,h.valid?($=i,await chrome.storage.local.set({[Z.API_KEY]:s.apiKey}),{success:!0,result:{valid:!0}}):{success:!1,error:h.error||"API Key无效",result:{quotaExceeded:h.quotaExceeded}}}catch(i){return ,console.error("[Background] Test API Key failed:",i),{success:!1,error:i.message||"API Key测试失败"}}}async function De(){try{const[s]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(s!=null&&s.id))return{success:!1,error:"无法获取当前标签页"};const t=await chrome.scripting.executeScript({target:{tabId:s.id,allFrames:!0},func:()=>{const n=document.querySelectorAll("ul.card-list li.card-item");if(n.length>0)return{count:n.length,method:"ul.card-list",frameUrl:window.location.href};const i=document.querySelectorAll("li.card-item");if(i.length>0)return{count:i.length,method:"global li.card-item",frameUrl:window.location.href};const h=document.querySelector("#recommend-list");if(h){const o=h.querySelectorAll("li");if(o.length>0)return{count:o.length,method:"#recommend-list li",frameUrl:window.location.href}}return{count:0,method:"none",frameUrl:window.location.href}}});let e={count:0,method:"none",frameUrl:""};for(const n of t)n.result&&n.result.count>e.count&&(e=n.result);return{success:!0,result:e}}catch(s){return console.error("[Background] getCandidatesFromPage failed:",s),{success:!1,error:s.message||"获取失败"}}}async function Ne(s,t){try{const[e]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!(e!=null&&e.id))return{success:!1,error:"无法获取当前标签页"};const n=await chrome.scripting.executeScript({target:{tabId:e.id,allFrames:!0},args:[s,t],func:async(a,u)=>{var g,I,p,S,N,B,J,j,M,H,U,Y,Q,V;if(a==="CLICK_CARD"){const b=document.querySelectorAll("li.card-item")[u.index];if(b){const T=b.querySelector(".card-inner");if(T)return T.click(),{success:!0,clicked:!0}}return{success:!1,error:"未找到候选人卡片"}}if(a==="CLICK_GREET"){;const f=document.querySelector('[class*="dialog-lib-resume"]');if(,!f)return{success:!1,error:"当前frame无详情页Dialog，跳过"};const b=f.querySelector("button.btn-greet"),T=f.querySelector("button.btn-sure-v2.btn-greet"),d=f.querySelector("button.btn-v2.btn-sure-v2.btn-greet"),r=f.querySelector("button.btn-outline-v2"),m=f.querySelectorAll("button"),R=[];m.forEach((C,_)=>{var F;const O=((F=C.textContent)==null?void 0:F.trim())||"";(O.includes("打招呼")||O.includes("继续沟通"))&&R.push({index:_,text:O,classes:C.className,disabled:C.disabled,outerHTML:C.outerHTML.substring(0,200)})}),;const l=b||T||d,y={frameUrl:window.location.href,hasDialog:!!f,dialogId:f.id,dialogClasses:f.className,buttonFound:!!l,buttonDisabled:l==null?void 0:l.disabled,buttonText:(N=l==null?void 0:l.textContent)==null?void 0:N.trim(),buttonClasses:l==null?void 0:l.className,continueButtonFound:!!r,continueButtonText:(B=r==null?void 0:r.textContent)==null?void 0:B.trim(),allMatchingButtons:R};return console.log("[executePageAction] CLICK_GREET debug:",y),r&&((J=r.textContent)!=null&&J.trim().includes("继续沟通"))?{success:!0,clicked:!1,alreadyGreeted:!0,debug:y}:l&&!l.disabled?(l.click(),{success:!0,clicked:!0,debug:y}):{success:!1,error:"未找到打招呼按钮或按钮已禁用",debug:y}}if(a==="CLOSE_DETAIL"){if(!document.querySelector('[class*="dialog-lib-resume"]'))return{success:!1,error:"当前frame无Dialog，跳过"};const b=document.querySelector(".icon-close");return b?(b.click(),{success:!0,closed:!0}):(document.dispatchEvent(new KeyboardEvent("keydown",{key:"Escape"})),{success:!0,closed:!0})}if(a==="GET_CANDIDATE_INFO"){const b=document.querySelectorAll("li.card-item")[u.index];if(b){const T=((H=(M=b.querySelector(".name"))==null?void 0:M.textContent)==null?void 0:H.trim())||"未知",d=((Y=(U=b.querySelector(".base-info"))==null?void 0:U.textContent)==null?void 0:Y.trim())||"";return{success:!0,info:{name:T,baseInfo:d}}}return{success:!1,error:"未找到候选人"}}if(a==="GET_CANVAS_RECT"){;const f=document.querySelector('[class*="dialog-lib-resume"]'),b=window.location.href,T=b.includes("/c-resume/");if(,f&&!T){;const d=f.getBoundingClientRect();let r=null,m=null;const R=["#wrap > div.side-wrap.side-wrap-v2","div.side-wrap.side-wrap-v2",".side-wrap-v2",".side-wrap","#wrap div.side-wrap","body > div.side-wrap"];for(const c of R)if(r=document.querySelector(c),r){const x={selector:c,hasSidebar:!!r,sidebarId:r==null?void 0:r.id,sidebarClasses:r==null?void 0:r.className,foundIn:"currentFrame"};;break}if(!r&&window.top&&window.top!==window)try{const c=window.top.document;for(const x of R)if(r=c.querySelector(x),r){const z={selector:x,hasSidebar:!!r,sidebarId:r==null?void 0:r.id,sidebarClasses:r==null?void 0:r.className,foundIn:"topFrame"};;break}}catch(c){}if(r)try{if(m=r.getBoundingClientRect(),window.top&&window.top!==window&&r.ownerDocument===window.top.document){const c={sidebarRectInTopFrame:{x:m.x,y:m.y,width:m.width,height:m.height,right:m.right,bottom:m.bottom},topFrameViewport:{width:window.top.innerWidth,height:window.top.innerHeight},currentFrameViewport:{width:window.innerWidth,height:window.innerHeight},devicePixelRatio:window.devicePixelRatio||1,pageZoom:((Q=window.top.visualViewport)==null?void 0:Q.scale)||1};}else{const c={sidebarRectInCurrentFrame:{x:m.x,y:m.y,width:m.width,height:m.height,right:m.right,bottom:m.bottom},currentFrameViewport:{width:window.innerWidth,height:window.innerHeight},devicePixelRatio:window.devicePixelRatio||1};}}catch(c){};const l=f.querySelector(".resume-layout-wrap");;const y=l==null?void 0:l.querySelector(".resume-middle-wrap"),C=(l==null?void 0:l.querySelector(".resume-left-side"))||(l==null?void 0:l.querySelector('[class*="left"]'))||f.querySelector(".resume-left-side")||f.querySelector('[class*="left-side"]');;const _=f.querySelector('iframe[src*="c-resume"]');let O;if(_){const c=_.getBoundingClientRect();;let x=null;if(_.contentWindow)try{const k=(_.contentDocument||_.contentWindow.document).querySelector("#resume");if(k){const pe=window.getComputedStyle(k),K=k.getBoundingClientRect(),oe=(k.parentElement||k).scrollHeight,ne=k.height||oe||K.height;x={width:k.width||K.width,height:K.height,scrollHeight:ne}}}catch(w){}const z=window.innerWidth||document.documentElement.clientWidth,ie=window.innerHeight||document.documentElement.clientHeight,me=window.devicePixelRatio||1;let te=1;try{window.visualViewport&&window.visualViewport.scale&&(te=window.visualViewport.scale)}catch{te=1}let E,D,A,P,q="unknown";if(y){const w=y.getBoundingClientRect();E=w.x,D=w.y,A=w.width,P=w.height,q="middle_wrap"}else if(C){const w=C.getBoundingClientRect();E=w.x,D=w.y,A=w.width,P=w.height,q="left_content_area"}else E=c.x,D=c.y,A=c.width,P=c.height,q="iframe",;if(,E<0&&(A=A+E,E=0),D<0&&(P=P+D,D=0),m){let w=m.right;window.top&&window.top!==window&&r&&(r.ownerDocument,window.top.document),w=m.right,E=w,A=d.right-w}else E=d.x,A=d.width;const se=1e4;x&&x.scrollHeight?P=Math.min(x.scrollHeight,se):c.height?P=Math.min(c.height,se):P=Math.min(d.height,se),A<100&&(A=Math.max(100,d.width)),P<100&&(P=Math.max(100,c.height||d.height)),O=new DOMRect(E,D,A,P)}else{const x=(f.querySelector(".boss-popup__content")||f).getBoundingClientRect();O=x}const F=window.innerWidth||document.documentElement.clientWidth,ee=window.innerHeight||document.documentElement.clientHeight;let v=O;const W=O.y,le=O.y+O.height,X=O.x,ge=O.x+O.width;(W<0||W>ee||X<0||X>F)&&(window.scrollTo({top:Math.max(0,W),left:Math.max(0,X),behavior:"instant"}),await new Promise(c=>setTimeout(c,300)),v=O,);const ue=_?_.getBoundingClientRect():null;return ,v.width===0||v.height===0?{success:!1,error:`截图区域尺寸为0 (${v.width}x${v.height})`}:{success:!0,rect:{x:v.x,y:v.y,width:v.width,height:v.height}}}if(T){const d=document.querySelector("#resume"),r=document.querySelector("canvas#resume"),m=document.querySelector("canvas"),R=r||m||d;if(R){const l=R.parentElement||R;l&&l.scrollHeight>l.clientHeight&&(,l.scrollTop=l.scrollHeight,await new Promise(C=>setTimeout(C,1500)),l.scrollTop=l.scrollHeight,await new Promise(C=>setTimeout(C,500)));const y=R.getBoundingClientRect();return ,y.width===0||y.height===0?{success:!1,error:`Canvas元素尺寸为0 (${y.width}x${y.height})`}:{success:!0,rect:{x:y.x,y:y.y,width:y.width,height:y.height}}}return{success:!1,error:"Resume frame中未找到Canvas元素"}}return f?{success:!1,error:"未找到Dialog内容区域"}:{success:!1,error:"当前frame无Dialog且非resume frame，跳过"}}return{success:!1,error:"未知操作"}}});let i=null,h=null,o=[];for(const a of n)if(a.result&&a.result.success){const u=a.result.rect;u?u.x>100?i=a.result:u.x===0&&u.width<=650?h=a.result:o.push(a.result):o.push(a.result)}if(i)return ,{success:!0,result:i};if(o.length>0)return ,{success:!0,result:o[0]};if(h)return ,{success:!0,result:h};for(const a of n)if(a.result&&!a.result.success&&a.result.error&&!a.result.error.includes("跳过"))return{success:!1,error:a.result.error};return{success:!1,error:"操作失败：所有frame都未找到目标元素"}}catch(e){return console.error("[Background] executePageAction failed:",e),{success:!1,error:e.message||"操作失败"}}}chrome.runtime.onMessage.addListener((s,t,e)=>{switch(console.log("[Background] Received message:",s.type),s.type){case L.ANALYZE_CANDIDATE:Re(s.payload).then(e).catch(n=>{console.error("[Background] Handler error:",n),e({success:!1,error:n.message||"处理失败"})});break;case L.TEST_API_KEY:ve(s.payload).then(e).catch(n=>{console.error("[Background] Handler error:",n),e({success:!1,error:n.message||"测试失败"})});break;case L.GET_CANDIDATES_FROM_PAGE:De().then(e).catch(n=>{console.error("[Background] Handler error:",n),e({success:!1,error:n.message||"获取失败"})});break;case L.CLICK_CARD:case L.CLICK_GREET:case L.CLOSE_DETAIL:case L.GET_CANDIDATE_INFO:case L.GET_CANVAS_RECT:Ne(s.type,s.payload).then(e).catch(n=>{console.error("[Background] Handler error:",n),e({success:!1,error:n.message||"操作失败"})});break;default:e({success:!1,error:`Unknown message type: ${s.type}`})}return!0});chrome.action.onClicked.addListener(async s=>{if(console.log("[Background] Extension icon clicked"),!s.id){console.error("[Background] No tab id found");return}try{await chrome.sidePanel.open({tabId:s.id}),console.log("[Background] Side panel opened")}catch(t){console.error("[Background] Failed to open side panel:",t);try{await chrome.sidePanel.setOptions({tabId:s.id,path:"src/sidepanel/index.html",enabled:!0}),await chrome.sidePanel.open({tabId:s.id})}catch(e){console.error("[Background] Retry failed:",e)}}});chrome.runtime.onInstalled.addListener(s=>{console.log("[Background] Extension installed/updated:",s.reason),s.reason==="install"?(console.log("[Background] First time installation"),chrome.sidePanel.setPanelBehavior({openPanelOnActionClick:!0}).catch(t=>{console.error("[Background] Failed to set panel behavior:",t)})):s.reason==="update"&&console.log("[Background] Extension updated")});console.log("[Background] Boss Greeting Assistant service worker loaded");
