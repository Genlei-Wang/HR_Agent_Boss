var L=Object.defineProperty;var P=(i,e,o)=>e in i?L(i,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):i[e]=o;var p=(i,e,o)=>P(i,typeof e!="symbol"?e+"":e,o);import{M as r,D as g,g as _}from"./utils-7X23tBXC.js";class U{constructor(){p(this,"isRunning",!1);p(this,"stats",{processed:0,matched:0,greeted:0,skipped:0});p(this,"sessionDir","");p(this,"lastScreenshotBase64")}async start(e){if(this.isRunning){console.warn("[AutomationController] Already running");return}this.isRunning=!0;const o=new Date().toISOString().replace(/[:.]/g,"-");this.sessionDir=`session_${o}`,console.log("[AutomationController] Starting automation"),console.log("[AutomationController] Session:",this.sessionDir);try{await chrome.runtime.sendMessage({type:r.CREATE_SESSION,payload:{}})}catch(n){console.error("[AutomationController] Failed to create session:",n)}this.sendStatusUpdate("running");try{await this.runAutomation(e),this.sendStatusUpdate("completed")}catch(n){console.error("[AutomationController] Error:",n),this.sendError(n.message||"自动化运行失败")}finally{this.stop()}}stop(){this.isRunning&&(console.log("[AutomationController] Stopping automation"),this.isRunning=!1,chrome.runtime.sendMessage({type:r.SAVE_SESSION,payload:{}}).catch(e=>{console.error("[AutomationController] Failed to save session:",e)}),this.sendStatusUpdate("idle"))}async runAutomation(e){console.log("[AutomationController] Starting automation...");const o=await chrome.runtime.sendMessage({type:r.GET_CANDIDATES_FROM_PAGE});if(!o.success||!o.result||o.result.count===0)throw new Error("未找到候选人列表");const n=o.result.count,a=e.candidateCount??g.CANDIDATE_COUNT,h=Math.min(a,n);console.log(`[AutomationController] ✅ 找到 ${n} 个候选人，将处理 ${h} 个`),this.stats={processed:0,matched:0,greeted:0,skipped:0};for(let c=0;c<h;c++){if(!this.isRunning){console.log("[AutomationController] Stopped by user");break}console.log(`[AutomationController] Processing candidate ${c+1}/${h}`);try{if(await this.processCandidate(c,e),this.stats.processed+=1,this.sendStatsUpdate(),c<h-1){const s=e.delayRange||{min:g.DELAY_MIN,max:g.DELAY_MAX},l=s.min??g.DELAY_MIN,f=s.max??g.DELAY_MAX,d=l+Math.random()*(f-l);await new Promise(m=>setTimeout(m,d*1e3))}}catch(s){console.error(`[AutomationController] Failed to process candidate ${c+1}:`,s);const l={id:_(),timestamp:new Date().toISOString(),candidateName:`候选人${c+1}`,candidateInfo:{},matchResult:!1,matchConfidence:0,matchReason:"",action:"error",errorMessage:s.message};this.sendLogUpdate(l)}}console.log("[AutomationController] Automation completed")}async processCandidate(e,o){var S,C,I,T,D,E,w,O,b,N,M;const n=await chrome.runtime.sendMessage({type:r.GET_CANDIDATE_INFO,payload:{index:e}}),a=((C=(S=n.result)==null?void 0:S.info)==null?void 0:C.name)||`候选人${e+1}`,h=((T=(I=n.result)==null?void 0:I.info)==null?void 0:T.baseInfo)||"";if(console.log(`[AutomationController] Processing: ${a}`),await new Promise(t=>setTimeout(t,1e3+Math.random()*2e3)),!(await chrome.runtime.sendMessage({type:r.CLICK_CARD,payload:{index:e}})).success)throw new Error("点击候选人卡片失败");await new Promise(t=>setTimeout(t,1500+Math.random()*1e3));let s=null;const l=5,f=1e3;for(let t=0;t<l;t++){if(,s=await chrome.runtime.sendMessage({type:r.GET_CANVAS_RECT,payload:{}}),s.success&&((D=s.result)!=null&&D.rect)){;break}t<l-1&&(,await new Promise(y=>setTimeout(y,f)))}let d=!1,m=0,u="";if(s&&s.success&&((E=s.result)!=null&&E.rect))try{const t=await chrome.runtime.sendMessage({type:r.ANALYZE_CANDIDATE,payload:{rect:s.result.rect,jobDescription:o.jobDescription,candidateInfo:{index:e,name:a,sessionDir:this.sessionDir}}});t.success&&t.result?(d=t.result.match,m=t.result.confidence,u=t.result.reason,this.lastScreenshotBase64=t.result.screenshotBase64,console.log(`[AutomationController] AI分析结果: ${d?"匹配":"不匹配"} (${(m*100).toFixed(0)}%)`)):(u="AI分析失败，默认不匹配",this.lastScreenshotBase64=void 0)}catch(t){console.error("[AutomationController] AI分析异常:",t),u=`AI分析异常: ${t.message}`,this.lastScreenshotBase64=void 0}else ,u=`未找到Canvas元素，默认不匹配${s!=null&&s.error?`: ${s.error}`:""}`;if(d){console.log(`[AutomationController] ${a} 匹配成功，准备打招呼`),await new Promise(y=>setTimeout(y,500+Math.random()*1e3));const t=await chrome.runtime.sendMessage({type:r.CLICK_GREET,payload:{}});,t.success?(this.stats.greeted+=1,this.stats.matched+=1,console.log(`[AutomationController] ${a} 打招呼成功`)):(console.warn(`[AutomationController] ${a} 打招呼失败:`,t.error),this.stats.skipped+=1,u="打招呼失败: "+t.error)}else console.log(`[AutomationController] ${a} 不匹配，跳过`),this.stats.skipped+=1;await new Promise(t=>setTimeout(t,1e3+Math.random()*2e3)),await chrome.runtime.sendMessage({type:r.CLOSE_DETAIL,payload:{}});const A={id:_(),timestamp:new Date().toISOString(),candidateName:a,candidateInfo:{age:((b=h.split("|")[0])==null?void 0:b.trim())||"",education:((N=h.split("|")[2])==null?void 0:N.trim())||""},matchResult:d,matchConfidence:m,matchReason:u,action:d?"greeted":"skipped",screenshotBase64:this.lastScreenshotBase64};,this.lastScreenshotBase64=void 0,this.sendLogUpdate(A)}sendLogUpdate(e){this.sendMessage(r.LOG_UPDATE,{log:e})}sendStatsUpdate(){this.sendMessage(r.STATS_UPDATE,{stats:this.stats})}sendStatusUpdate(e){this.sendMessage(r.STATUS_UPDATE,{status:e})}sendError(e){this.sendMessage(r.ERROR_OCCURRED,{message:e})}sendMessage(e,o){chrome.runtime.sendMessage({type:e,payload:o}).catch(n=>{console.error("[AutomationController] Failed to send message:",n)})}}const R=new U;chrome.runtime.onMessage.addListener((i,e,o)=>{switch(console.log("[Content Script] Received message:",i.type),i.type){case"PING":return o({success:!0,message:"Content Script is ready"}),!0;case r.START_AUTOMATION:i.payload?(R.start(i.payload).catch(n=>{console.error("[Content Script] Start automation failed:",n),o({success:!1,error:n.message})}),o({success:!0})):o({success:!1,error:"Missing config payload"});break;case r.STOP_AUTOMATION:R.stop(),o({success:!0});break;default:o({success:!1,error:"Unknown message type"})}return!0});document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{console.log("[Content Script] DOM loaded")}):console.log("[Content Script] Initialized");console.log("[Content Script] Boss Greeting Assistant content script loaded");
