# Cursor AI调试最佳实践：从截图功能调试中提炼的深刻经验

> **背景**：在开发Chrome扩展的截图功能时，我们花费了大量时间调试一个看似简单的坐标定位问题。最终通过系统化的调试方法解决了问题。本文档总结了这次调试的核心经验，供所有使用Cursor的AI和产品经理参考。

---

## 一、核心原则：基于运行时证据，而非代码猜测

### ❌ 错误做法
- 仅凭代码逻辑猜测问题原因
- 一次性修改多个地方，期望"总有一个是对的"
- 没有验证就认为修复成功

### ✅ 正确做法
1. **生成3-5个精确假设**：基于问题现象，提出具体的、可验证的假设
2. **添加诊断日志**：在关键位置添加日志，记录实际运行时的值
3. **分析日志证据**：用日志数据验证或否定每个假设
4. **基于证据修复**：只有100%确认时才修复，并保留日志用于验证

### 案例
**问题**：截图起点错误，包含了左侧目录栏

**假设1**：目录栏选择器错误 → 添加日志发现 `hasSidebar: false` → **REJECTED**
**假设2**：目录栏在top frame，坐标系统不匹配 → 添加日志发现目录栏在top frame → **CONFIRMED**
**假设3**：坐标是CSS像素，但图片是物理像素，需要转换 → 添加日志发现 `scaleX ≈ 2.35` → **CONFIRMED**

---

## 二、坐标系统陷阱：CSS像素 vs 物理像素

### 问题本质
- **CSS像素（逻辑像素）**：`getBoundingClientRect()` 返回的坐标，受页面缩放影响
- **物理像素（设备像素）**：`chrome.tabs.captureVisibleTab()` 捕获的图片尺寸，受 `devicePixelRatio` 影响
- **转换关系**：物理像素 = CSS像素 × devicePixelRatio × 页面缩放

### 关键发现
```typescript
// ❌ 错误：直接使用CSS像素坐标
const cropX = rect.x; // rect.x = 168 (CSS像素)
// 但图片宽度 = 2226px (物理像素)，缩放比例 ≈ 2.35

// ✅ 正确：转换为物理像素
const scaleX = imageBitmapWidth / viewportWidth; // ≈ 2.35
const cropX = rect.x * scaleX; // 168 * 2.35 ≈ 395 (物理像素)
```

### 经验教训
1. **永远不要假设坐标系统一致**：不同API可能使用不同的坐标系统
2. **记录实际值**：通过日志记录 `imageBitmapWidth`、`rect.x`、`scaleX` 等关键值
3. **验证转换**：计算后验证转换是否正确（如 `cropX + cropWidth` 是否在图片范围内）

---

## 三、多Frame环境的复杂性

### 问题场景
- 目录栏在 `window.top`（主frame）
- Dialog在当前frame（子frame）
- 坐标系统可能不一致

### 解决方案
```typescript
// 1. 尝试在当前frame查找
let sidebar = document.querySelector(selector);

// 2. 如果没找到，尝试在top frame查找
if (!sidebar && window.top && window.top !== window) {
  sidebar = window.top.document.querySelector(selector);
}

// 3. 获取坐标时考虑frame位置
const sidebarRect = sidebar.getBoundingClientRect();
// 如果sidebar在top frame，坐标已经是相对于浏览器视口的
// 如果sidebar在当前frame，需要考虑frame偏移
```

### 经验教训
1. **明确元素所在frame**：通过日志记录 `foundIn: 'topFrame'` 或 `foundIn: 'currentFrame'`
2. **验证坐标系统**：记录 `sidebarRect.right`、`dialogRect.right` 等关键值
3. **考虑frame偏移**：如果元素在不同frame，可能需要坐标转换

---

## 四、假设驱动的调试方法

### 标准流程
```
问题现象
  ↓
生成3-5个精确假设（H1, H2, H3...）
  ↓
为每个假设添加诊断日志（hypothesisId: 'H1', 'H2'...）
  ↓
运行程序，收集日志
  ↓
分析日志，评估每个假设（CONFIRMED/REJECTED/INCONCLUSIVE）
  ↓
基于确认的假设修复
  ↓
保留日志，再次运行验证
  ↓
如果失败，生成新的假设，重复流程
```

### 关键原则
1. **假设要具体**：不是"坐标有问题"，而是"坐标是CSS像素但图片是物理像素"
2. **日志要对应**：每个日志都要有 `hypothesisId`，方便追踪
3. **证据要确凿**：用日志中的实际值（如 `scaleX: 2.35`）证明假设

---

## 五、日志策略：结构化、可追踪、有价值

### 日志结构
```typescript
{
  location: 'file.ts:123',           // 代码位置
  message: '关键操作描述',            // 人类可读的描述
  data: {                            // 关键数据
    screenshotX: 168,
    scaleX: 2.35,
    imageBitmapWidth: 2226
  },
  hypothesisId: 'COORDINATE_CONVERSION', // 关联的假设
  timestamp: Date.now(),
  sessionId: 'debug-session',
  runId: 'canvas-analysis'
}
```

### 日志原则
1. **记录关键值**：坐标、尺寸、缩放比例等影响结果的值
2. **记录决策点**：哪个if/else分支被执行了
3. **记录转换过程**：从原始值到转换后的值
4. **使用唯一ID**：`hypothesisId`、`runId` 方便过滤和分析

---

## 六、迭代调试的耐心和系统性

### 常见陷阱
- **过早放弃**：尝试2-3次就认为"代码有问题"
- **盲目修改**：没有证据就修改代码
- **移除日志过早**：修复后立即移除日志，无法验证

### 正确做法
1. **保持日志**：修复后保留日志，用于验证和后续调试
2. **系统化迭代**：每次迭代都基于新的证据，生成新的假设
3. **记录过程**：记录每次尝试和结果，避免重复

---

## 七、给产品经理的建议

### 1. 理解技术复杂性
- **不要低估"简单"功能**：截图功能看似简单，但涉及坐标系统、多frame、缩放等多个复杂因素
- **预留调试时间**：复杂功能的调试时间可能是开发时间的2-3倍

### 2. 与AI协作的最佳实践
- **提供完整上下文**：问题现象、相关代码、日志输出
- **分步骤验证**：不要一次性要求修复所有问题
- **基于证据决策**：要求AI提供日志证据，而非仅凭代码猜测

### 3. 质量保证
- **关键功能必须有日志**：便于问题定位和验证
- **保留调试日志**：即使功能正常，也保留关键日志用于后续维护
- **文档化经验**：将调试过程中的关键发现文档化，避免重复踩坑

---

## 八、给AI开发者的建议

### 1. 使用Debug模式
- **强制基于证据**：Debug模式要求基于运行时证据，而非代码猜测
- **系统化假设**：生成多个假设，逐一验证
- **保留日志**：修复后保留日志用于验证

### 2. 理解坐标系统
- **CSS像素 vs 物理像素**：理解不同API使用的坐标系统
- **devicePixelRatio**：理解高DPI屏幕的影响
- **多frame环境**：理解frame之间的坐标系统差异

### 3. 日志策略
- **结构化日志**：使用统一的日志格式，便于分析
- **关键值记录**：记录影响结果的关键值（坐标、尺寸、缩放比例等）
- **假设追踪**：使用 `hypothesisId` 追踪每个假设的验证过程

---

## 九、关键经验总结

1. **基于运行时证据，而非代码猜测**：这是最重要的原则
2. **理解坐标系统**：CSS像素 vs 物理像素，devicePixelRatio的影响
3. **多frame环境的复杂性**：元素可能在不同frame，坐标系统可能不一致
4. **假设驱动的调试**：生成假设 → 添加日志 → 验证假设 → 基于证据修复
5. **结构化日志**：记录关键值、决策点、转换过程
6. **迭代调试的耐心**：保持日志，系统化迭代，记录过程

---

## 十、实战检查清单

在调试复杂功能时，使用以下检查清单：

- [ ] 是否生成了3-5个精确假设？
- [ ] 是否为每个假设添加了诊断日志？
- [ ] 是否记录了关键值（坐标、尺寸、缩放比例等）？
- [ ] 是否用日志证据验证了每个假设？
- [ ] 是否理解了坐标系统（CSS像素 vs 物理像素）？
- [ ] 是否考虑了多frame环境的复杂性？
- [ ] 修复后是否保留了日志用于验证？
- [ ] 是否记录了调试过程和关键发现？

---

**最后的话**：调试是一个系统化的过程，需要耐心、证据和迭代。不要急于求成，基于证据逐步推进，最终一定能解决问题。

