# AI调试实战指南：从截图功能调试中提炼的5个核心经验

> **一句话总结**：调试复杂功能时，必须基于运行时证据，而非代码猜测。这是本次调试最重要的经验。

---

## 经验1：基于证据，而非猜测

### 问题
截图起点错误，包含了左侧目录栏。我们尝试了多种修复，但都不对。

### 正确做法
1. **生成假设**：提出3-5个具体假设（如"坐标系统不匹配"）
2. **添加日志**：在关键位置记录实际运行时的值
3. **验证假设**：用日志数据验证或否定每个假设
4. **基于证据修复**：只有100%确认时才修复

### 案例
```
假设1：目录栏选择器错误
  → 添加日志：hasSidebar: false
  → 结果：REJECTED（目录栏确实找到了）

假设2：坐标系统不匹配
  → 添加日志：scaleX: 2.35, rect.x: 168
  → 结果：CONFIRMED（CSS像素 vs 物理像素）
```

---

## 经验2：理解坐标系统陷阱

### 核心问题
- **CSS像素**：`getBoundingClientRect()` 返回的坐标（如 `x: 168`）
- **物理像素**：`chrome.tabs.captureVisibleTab()` 捕获的图片尺寸（如 `width: 2226`）
- **转换关系**：物理像素 = CSS像素 × devicePixelRatio（约2.35倍）

### 错误代码
```typescript
const cropX = rect.x; // ❌ 直接使用CSS像素，但图片是物理像素
```

### 正确代码
```typescript
const scaleX = imageBitmapWidth / viewportWidth; // ≈ 2.35
const cropX = rect.x * scaleX; // ✅ 转换为物理像素
```

### 教训
**永远不要假设坐标系统一致**。不同API可能使用不同的坐标系统，必须通过日志验证。

---

## 经验3：多Frame环境的复杂性

### 问题场景
- 目录栏在 `window.top`（主frame）
- Dialog在当前frame（子frame）
- 坐标系统可能不一致

### 解决方案
```typescript
// 1. 在当前frame查找
let sidebar = document.querySelector(selector);

// 2. 如果没找到，在top frame查找
if (!sidebar && window.top) {
  sidebar = window.top.document.querySelector(selector);
}

// 3. 获取坐标时考虑frame位置
const sidebarRect = sidebar.getBoundingClientRect();
// 如果sidebar在top frame，坐标已经是相对于浏览器视口的
```

### 教训
**明确元素所在frame**，通过日志记录 `foundIn: 'topFrame'` 或 `foundIn: 'currentFrame'`。

---

## 经验4：假设驱动的调试流程

### 标准流程
```
问题现象
  ↓
生成3-5个精确假设
  ↓
为每个假设添加诊断日志
  ↓
运行程序，收集日志
  ↓
分析日志，评估假设（CONFIRMED/REJECTED）
  ↓
基于确认的假设修复
  ↓
保留日志，再次运行验证
```

### 关键原则
1. **假设要具体**：不是"坐标有问题"，而是"坐标是CSS像素但图片是物理像素"
2. **日志要对应**：每个日志都要有 `hypothesisId`，方便追踪
3. **证据要确凿**：用日志中的实际值证明假设

---

## 经验5：结构化日志策略

### 日志结构
```typescript
{
  location: 'file.ts:123',           // 代码位置
  message: '关键操作描述',            // 人类可读的描述
  data: {                            // 关键数据
    screenshotX: 168,
    scaleX: 2.35,
    imageBitmapWidth: 2226
  },
  hypothesisId: 'COORDINATE_CONVERSION', // 关联的假设
  timestamp: Date.now()
}
```

### 日志原则
1. **记录关键值**：坐标、尺寸、缩放比例等影响结果的值
2. **记录决策点**：哪个if/else分支被执行了
3. **记录转换过程**：从原始值到转换后的值
4. **使用唯一ID**：`hypothesisId`、`runId` 方便过滤和分析

---

## 给产品经理的3个建议

### 1. 理解技术复杂性
- **不要低估"简单"功能**：截图功能看似简单，但涉及坐标系统、多frame、缩放等多个复杂因素
- **预留调试时间**：复杂功能的调试时间可能是开发时间的2-3倍

### 2. 与AI协作的最佳实践
- **提供完整上下文**：问题现象、相关代码、日志输出
- **分步骤验证**：不要一次性要求修复所有问题
- **基于证据决策**：要求AI提供日志证据，而非仅凭代码猜测

### 3. 质量保证
- **关键功能必须有日志**：便于问题定位和验证
- **保留调试日志**：即使功能正常，也保留关键日志用于后续维护
- **文档化经验**：将调试过程中的关键发现文档化，避免重复踩坑

---

## 给AI开发者的3个建议

### 1. 使用Debug模式
- **强制基于证据**：Debug模式要求基于运行时证据，而非代码猜测
- **系统化假设**：生成多个假设，逐一验证
- **保留日志**：修复后保留日志用于验证

### 2. 理解坐标系统
- **CSS像素 vs 物理像素**：理解不同API使用的坐标系统
- **devicePixelRatio**：理解高DPI屏幕的影响
- **多frame环境**：理解frame之间的坐标系统差异

### 3. 日志策略
- **结构化日志**：使用统一的日志格式，便于分析
- **关键值记录**：记录影响结果的关键值（坐标、尺寸、缩放比例等）
- **假设追踪**：使用 `hypothesisId` 追踪每个假设的验证过程

---

## 实战检查清单

在调试复杂功能时，使用以下检查清单：

- [ ] 是否生成了3-5个精确假设？
- [ ] 是否为每个假设添加了诊断日志？
- [ ] 是否记录了关键值（坐标、尺寸、缩放比例等）？
- [ ] 是否用日志证据验证了每个假设？
- [ ] 是否理解了坐标系统（CSS像素 vs 物理像素）？
- [ ] 是否考虑了多frame环境的复杂性？
- [ ] 修复后是否保留了日志用于验证？

---

## 核心经验总结

1. **基于运行时证据，而非代码猜测** ⭐⭐⭐⭐⭐
2. **理解坐标系统陷阱** ⭐⭐⭐⭐
3. **多frame环境的复杂性** ⭐⭐⭐⭐
4. **假设驱动的调试方法** ⭐⭐⭐⭐
5. **结构化日志策略** ⭐⭐⭐

---

**最后的话**：调试是一个系统化的过程，需要耐心、证据和迭代。不要急于求成，基于证据逐步推进，最终一定能解决问题。

