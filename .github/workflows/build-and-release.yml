name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€ç‰ˆæœ¬æ ‡ç­¾æ—¶è§¦å‘ï¼Œä¾‹å¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Cache node modules
        uses: actions/cache@v4
        with:
          path: boss-greeting-assistant/node_modules
          key: ${{ runner.os }}-node-${{ hashFiles('boss-greeting-assistant/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-
      
      - name: Install dependencies
        working-directory: ./boss-greeting-assistant
        run: npm ci
      
      - name: Build production version
        working-directory: ./boss-greeting-assistant
        run: npm run build:prod
      
      - name: Package extension
        working-directory: ./boss-greeting-assistant
        run: |
          # åˆ›å»ºæ‰“åŒ…ç›®å½•
          mkdir -p dist-package
          cp -r dist/* dist-package/
          
          # åˆ›å»ºå®‰è£…è¯´æ˜Ž
          cat > dist-package/å®‰è£…è¯´æ˜Ž.txt << EOF
          Bossæ‹›è˜æ™ºèƒ½åŠ©æ‰‹ - å®‰è£…è¯´æ˜Ž
          ç‰ˆæœ¬: $(node -p "require('./package.json').version")
          æž„å»ºæ—¶é—´: $(date +%Y-%m-%d\ %H:%M:%S)
          
          å®‰è£…æ­¥éª¤ï¼š
          1. æ‰“å¼€Chromeæµè§ˆå™¨
          2. è®¿é—® chrome://extensions/
          3. å¼€å¯å³ä¸Šè§’çš„"å¼€å‘è€…æ¨¡å¼"
          4. ç‚¹å‡»"åŠ è½½å·²è§£åŽ‹çš„æ‰©å±•ç¨‹åº"
          5. é€‰æ‹©è¿™ä¸ªæ–‡ä»¶å¤¹ï¼ˆdist-packageï¼‰
          
          è¯¦ç»†è¯´æ˜Žè¯·æŸ¥çœ‹ï¼šdocs/HRå®‰è£…ä½¿ç”¨æŒ‡å—.md
          EOF
      
      - name: Create ZIP package
        working-directory: ./boss-greeting-assistant
        run: |
          cd ..
          zip -r boss-greeting-assistant-v$(node -p "require('./boss-greeting-assistant/package.json').version").zip boss-greeting-assistant/dist-package/ -x "*.DS_Store" "*.git*"
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: extension-package
          path: boss-greeting-assistant-v*.zip
          retention-days: 90
      
      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: boss-greeting-assistant-v*.zip
          body: |
            ## Bossæ‹›è˜æ™ºèƒ½åŠ©æ‰‹ v${{ github.ref_name }}
            
            ### ðŸ“¦ ä¸‹è½½å®‰è£…åŒ…
            ç‚¹å‡»ä¸‹æ–¹ä¸‹è½½æŒ‰é’®ï¼Œä¸‹è½½ `boss-greeting-assistant-v${{ github.ref_name }}.zip`
            
            ### ðŸ“– å®‰è£…æ­¥éª¤
            1. è§£åŽ‹ZIPæ–‡ä»¶
            2. æ‰“å¼€Chromeæµè§ˆå™¨ â†’ `chrome://extensions/`
            3. å¼€å¯"å¼€å‘è€…æ¨¡å¼"
            4. ç‚¹å‡»"åŠ è½½å·²è§£åŽ‹çš„æ‰©å±•ç¨‹åº"
            5. é€‰æ‹©è§£åŽ‹åŽçš„æ–‡ä»¶å¤¹
            
            ### ðŸ“š è¯¦ç»†æ–‡æ¡£
            - [HRå®‰è£…ä½¿ç”¨æŒ‡å—](docs/HRå®‰è£…ä½¿ç”¨æŒ‡å—.md)
            - [å¿«é€Ÿåˆ†å‘æŒ‡å—](å¿«é€Ÿåˆ†å‘æŒ‡å—.md)
            
            ### ðŸ” å®‰å…¨è¯´æ˜Ž
            - âœ… å·²ç§»é™¤æ‰€æœ‰è°ƒè¯•ä»£ç 
            - âœ… API Keyä»…å­˜å‚¨åœ¨æœ¬åœ°ï¼Œä¸ä¼šæ³„éœ²
            - âœ… æ”¯æŒMacå’ŒWindowsï¼Œä¸åŒåˆ†è¾¨çŽ‡
            
            ### ðŸ“ æ›´æ–°æ—¥å¿—
            æŸ¥çœ‹ [CHANGELOG.md](CHANGELOG.md) äº†è§£è¯¦ç»†æ›´æ–°å†…å®¹
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

